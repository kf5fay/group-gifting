<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Gift Exchange</title>
    <style>
        :root {
            /* Christmas Theme (Default) */
            --primary-color: #c41e3a;
            --primary-dark: #a01729;
            --secondary-color: #165b33;
            --secondary-dark: #0e4023;
            --bg-gradient-start: #1e3a5f;
            --bg-gradient-end: #2d5a3d;
            --accent-color: #ffeb3b;
            --decoration: '‚ùÑ';
        }

        body.birthday-theme {
            --primary-color: #ff6b9d;
            --primary-dark: #e94980;
            --secondary-color: #9c27b0;
            --secondary-dark: #7b1fa2;
            --bg-gradient-start: #f8bbd0;
            --bg-gradient-end: #ce93d8;
            --accent-color: #ffd54f;
            --decoration: 'üéà';
        }

        body.hanukkah-theme {
            --primary-color: #1976d2;
            --primary-dark: #1565c0;
            --secondary-color: #0d47a1;
            --secondary-dark: #01579b;
            --bg-gradient-start: #2c3e50;
            --bg-gradient-end: #34495e;
            --accent-color: #ffffff;
            --decoration: '‚ú°';
        }

        body.anniversary-theme {
            --primary-color: #e91e63;
            --primary-dark: #c2185b;
            --secondary-color: #880e4f;
            --secondary-dark: #560027;
            --bg-gradient-start: #fce4ec;
            --bg-gradient-end: #f8bbd0;
            --accent-color: #ffd700;
            --decoration: 'üíñ';
        }

        body.other-theme {
            --primary-color: #ff9800;
            --primary-dark: #f57c00;
            --secondary-color: #e65100;
            --secondary-dark: #bf360c;
            --bg-gradient-start: #fff3e0;
            --bg-gradient-end: #ffe0b2;
            --accent-color: #ffeb3b;
            --decoration: 'üéâ';
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            transition: background 0.5s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: background 0.5s ease;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .setup-form, .join-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 0.95em;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.5s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(196, 30, 58, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .secondary-btn {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
        }

        .secondary-btn:hover {
            box-shadow: 0 4px 12px rgba(22, 91, 51, 0.4);
        }

        .info-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .share-section {
            background: #f0f8ff;
            border: 2px dashed #2196F3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .share-section h3 {
            color: #1976D2;
            margin-bottom: 15px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-link {
            background: white;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
            margin: 10px 0;
            border: 1px solid #ddd;
        }

        /* Grid Layout for Wishlists */
        .wishlists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            margin-top: 40px;
        }

        .wishlist-section {
            margin-bottom: 0;
        }

        .wishlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary-color);
        }

        .wishlist-header h2 {
            color: var(--secondary-color);
            font-size: 1.5em;
        }

        .badge {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .add-item-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .add-item-form input, .add-item-form select {
            flex: 1;
        }

        .item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s;
            cursor: pointer;
        }

        .item.claimed {
            opacity: 0.7;
            border-left-color: var(--primary-color);
        }

        .item.claimed .item-text {
            text-decoration: line-through;
        }

        .item.purchased {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .item-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 10px;
        }

        .item-text {
            font-size: 1.1em;
            color: #333;
            word-wrap: break-word;
            flex: 1;
        }

        .item-details {
            font-size: 0.9em;
            color: #666;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            margin-top: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #e0e0e0;
        }

        .item-details a {
            color: #2196F3;
            text-decoration: none;
        }

        .item-details a:hover {
            text-decoration: underline;
        }

        .edit-details-btn {
            font-size: 0.85em;
            padding: 6px 12px;
            margin-top: 8px;
        }

        .item-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .meta-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority-low {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .price-badge {
            background: #e3f2fd;
            color: #1565c0;
        }

        .item-notes {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
            padding-left: 10px;
            border-left: 2px solid #e0e0e0;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .item-actions button {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .claimed-by {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            margin-top: 8px;
        }

        .purchased-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            margin-left: 8px;
        }

        .split-badge {
            background: #ff9800;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            margin-left: 8px;
        }

        .group-info {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
        }

        .group-info strong {
            color: var(--accent-color);
        }

        .reset-btn {
            background: #666;
            padding: 10px 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .reset-btn:hover {
            background: #555;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        .modal-header {
            font-size: 1.5em;
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }

            .header .subtitle {
                font-size: 0.95em;
            }

            .card {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .item-actions {
                flex-direction: column;
            }

            .item-actions button {
                width: 100%;
            }

            .share-buttons {
                flex-direction: column;
            }

            .modal-content {
                margin: 20% auto;
                padding: 20px;
            }

            .wishlists-grid {
                grid-template-columns: 1fr;
            }
        }

        .snowflake {
            position: fixed;
            top: -10px;
            z-index: 9999;
            user-select: none;
            pointer-events: none;
            color: white;
            font-size: 1em;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup View -->
        <div id="setupView" style="display: none;">
            <div class="header">
                <h1>üéÑ Holiday Gift Exchange üéÅ</h1>
                <p class="subtitle">Create your gift exchange group</p>
            </div>
            <div class="card">
                <form class="setup-form" id="setupForm">
                    <div class="form-group">
                        <label for="groupName">Family/Group Name</label>
                        <input type="text" id="groupName" required placeholder="e.g., Smith Family, Work Friends">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventType">Event</label>
                            <select id="eventType" required>
                                <option value="Christmas">Christmas</option>
                                <option value="Birthday">Birthday</option>
                                <option value="Hanukkah">Hanukkah</option>
                                <option value="Anniversary">Anniversary</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventDate">Event Date</label>
                            <input type="date" id="eventDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="setupUserName">Your Name</label>
                        <input type="text" id="setupUserName" required placeholder="Enter your name">
                    </div>
                    <button type="submit">Create Group üéâ</button>
                </form>
            </div>
        </div>

        <!-- Join View -->
        <div id="joinView" style="display: none;">
            <div class="header">
                <h1>üéÑ Holiday Gift Exchange üéÅ</h1>
                <p class="subtitle">Join an existing group</p>
            </div>
            <div class="card">
                <div id="joinGroupInfo" style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 10px;"></div>
                <form class="join-form" id="joinForm">
                    <div class="form-group">
                        <label for="joinUserName">Your Name</label>
                        <input type="text" id="joinUserName" required placeholder="Enter your name">
                    </div>
                    <button type="submit">Join Group üéâ</button>
                </form>
            </div>
        </div>

        <!-- Main View -->
        <div id="mainView" style="display: none;">
            <div class="header">
                <h1>üéÑ Holiday Gift Exchange üéÅ</h1>
                <div class="group-info" id="groupInfo"></div>
            </div>

            <!-- Share Section -->
            <div class="share-section">
                <h3>üì§ Share with Your Group</h3>
                <p style="margin-bottom: 10px; color: #666;">Send this link to your family & friends:</p>
                <div class="share-link" id="shareLink"></div>
                <div class="share-buttons">
                    <button class="info-btn" onclick="copyLink()">üìã Copy Link</button>
                    <button class="info-btn" onclick="shareLink()">üì± Share</button>
                </div>
            </div>

            <!-- Your Wishlist -->
            <div class="card wishlist-section">
                <div class="wishlist-header">
                    <h2>My Wishlist</h2>
                    <span class="badge" id="myWishlistCount">0 items</span>
                </div>
                <div class="add-item-form">
                    <input type="text" id="newItemInput" placeholder="What would you like for this occasion?" />
                    <div class="form-row">
                        <select id="newItemPriority">
                            <option value="medium">Priority: Medium</option>
                            <option value="high">Priority: High</option>
                            <option value="low">Priority: Low</option>
                        </select>
                        <select id="newItemPrice">
                            <option value="">Price Range (Optional)</option>
                            <option value="Under $25">Under $25</option>
                            <option value="$25-$50">$25-$50</option>
                            <option value="$50-$100">$50-$100</option>
                            <option value="$100+">$100+</option>
                        </select>
                    </div>
                    <button onclick="addItem()">Add Item ‚ûï</button>
                </div>
                <div id="myWishlist"></div>
            </div>

            <!-- Others' Wishlists -->
            <div class="wishlists-grid" id="othersWishlists"></div>

            <!-- Reset Section (Creator Only) -->
            <div class="card" id="resetSection" style="text-align: center; display: none;">
                <button class="reset-btn" onclick="resetData()">Reset Everything üîÑ</button>
            </div>
        </div>
    </div>

    <!-- Split Gift Modal -->
    <div id="splitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Split This Gift?</div>
            <div class="modal-body" id="splitModalBody"></div>
            <div class="modal-buttons">
                <button class="secondary-btn" onclick="closeSplitModal()">Cancel</button>
                <button onclick="confirmSplit()">Yes, Split It! üéÅ</button>
            </div>
        </div>
    </div>

    <!-- Edit Details Modal -->
    <div id="editDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Gift Details</div>
            <div class="modal-body">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2d5a3d;">Add details like size, color, links, etc.:</label>
                <textarea id="editDetailsTextarea" style="width: 100%; min-height: 120px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="Example:&#10;Size: Large&#10;Color: Navy Blue&#10;Amazon: https://amazon.com/...&#10;&#10;Links will automatically become clickable!"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="secondary-btn" onclick="closeEditDetailsModal()">Cancel</button>
                <button onclick="saveEditDetails()">Save Details ‚úì</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = '';
        let groupData = null;
        let groupId = '';
        let splitModalData = null;
        let editDetailsData = null;
        let isGroupCreator = false;
        let pollInterval = null;
        let lastDataHash = '';
        let currentDecoration = '‚ùÑ';

        // Generate unique ID
        function generateId() {
            return Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
        }

        // Helper function to make URLs clickable
        function linkify(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
        }

        // Theme Management
        function applyTheme(eventType) {
            const themeMap = {
                'Christmas': '',
                'Birthday': 'birthday-theme',
                'Hanukkah': 'hanukkah-theme',
                'Anniversary': 'anniversary-theme',
                'Other': 'other-theme'
            };
            
            document.body.className = themeMap[eventType] || '';
            
            // Update decoration emoji
            const decorationMap = {
                'Christmas': '‚ùÑ',
                'Birthday': 'üéà',
                'Hanukkah': '‚ú°',
                'Anniversary': 'üíñ',
                'Other': 'üéâ'
            };
            
            currentDecoration = decorationMap[eventType] || '‚ùÑ';
        }

        // Get group ID from URL or create new one
        function getGroupId() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                return hash;
            }
            return null;
        }

        // Set group ID in URL
        function setGroupId(id) {
            window.location.hash = id;
        }

        // Create a hash of the data to detect changes
        function hashData(data) {
            return JSON.stringify(data);
        }

        // API Functions
        async function loadGroupData(groupId) {
            try {
                const response = await fetch(`/api/groups/${groupId}`);
                const result = await response.json();
                if (result.success) {
                    return result.data;
                }
                return null;
            } catch (error) {
                console.error('Error loading group:', error);
                return null;
            }
        }

        async function saveGroupData(groupId, data) {
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error saving group:', error);
                return false;
            }
        }

        async function deleteGroupData(groupId) {
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error deleting group:', error);
                return false;
            }
        }

        // Live polling for updates
        async function pollForUpdates() {
            if (!groupId || !groupData) return;

            try {
                const freshData = await loadGroupData(groupId);
                if (freshData) {
                    const newHash = hashData(freshData);
                    if (newHash !== lastDataHash) {
                        // Data has changed, update UI
                        groupData = freshData;
                        lastDataHash = newHash;
                        renderMainView();
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        // Start live polling
        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            // Poll every 3 seconds
            pollInterval = setInterval(pollForUpdates, 3000);
        }

        // Stop polling
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Decoration effect (changes based on theme)
        function createSnowflake() {
            const decoration = document.createElement('div');
            decoration.classList.add('snowflake');
            decoration.innerHTML = currentDecoration;
            decoration.style.left = Math.random() * 100 + '%';
            decoration.style.animationDuration = (Math.random() * 3 + 2) + 's';
            decoration.style.opacity = Math.random();
            decoration.style.fontSize = (Math.random() * 10 + 10) + 'px';
            document.body.appendChild(decoration);

            setTimeout(() => {
                decoration.remove();
            }, 5000);
        }

        setInterval(createSnowflake, 300);

        // Initialize app
        async function init() {
            groupId = getGroupId();
            
            if (groupId) {
                // Try to load existing group
                groupData = await loadGroupData(groupId);
                const savedUser = localStorage.getItem(`user_${groupId}`);
                const savedCreator = localStorage.getItem(`creator_${groupId}`);

                if (groupData) {
                    // Apply theme based on event type
                    if (groupData.eventType) {
                        applyTheme(groupData.eventType);
                    }

                    // Check if saved user is the creator
                    if (savedUser && savedUser === groupData.createdBy) {
                        isGroupCreator = true;
                    }

                    if (savedUser && groupData.users[savedUser]) {
                        currentUser = savedUser;
                        lastDataHash = hashData(groupData);
                        showMainView();
                        startPolling();
                    } else {
                        showJoinView();
                    }
                } else {
                    // Group doesn't exist, create new
                    showSetupView();
                }
            } else {
                // No group ID, show setup
                showSetupView();
            }
        }

        function showSetupView() {
            stopPolling();
            document.getElementById('setupView').style.display = 'block';
            document.getElementById('joinView').style.display = 'none';
            document.getElementById('mainView').style.display = 'none';
            
            // Set default date to Christmas if December
            const today = new Date();
            const thisYear = today.getFullYear();
            document.getElementById('eventDate').value = `${thisYear}-12-25`;
        }

        function showJoinView() {
            stopPolling();
            document.getElementById('setupView').style.display = 'none';
            document.getElementById('joinView').style.display = 'block';
            document.getElementById('mainView').style.display = 'none';
            
            // Apply theme based on event type
            if (groupData && groupData.eventType) {
                applyTheme(groupData.eventType);
            }
            
            // Show group info
            const eventDate = new Date(groupData.eventDate);
            document.getElementById('joinGroupInfo').innerHTML = `
                <h3 style="color: #2d5a3d; margin-bottom: 10px;">${groupData.groupName}</h3>
                <p><strong>Event:</strong> ${groupData.eventType}</p>
                <p><strong>Date:</strong> ${eventDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p style="margin-top: 10px;"><strong>${Object.keys(groupData.users).length}</strong> member(s) already joined</p>
            `;
        }

        function showMainView() {
            document.getElementById('setupView').style.display = 'none';
            document.getElementById('joinView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            renderMainView();
        }

        // Setup form submission
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = document.getElementById('groupName').value.trim();
            const eventType = document.getElementById('eventType').value;
            const eventDate = document.getElementById('eventDate').value;
            const userName = document.getElementById('setupUserName').value.trim();

            groupId = generateId();
            setGroupId(groupId);

            groupData = {
                groupName: groupName,
                eventType: eventType,
                eventDate: eventDate,
                createdBy: userName,
                people: {}
            };

            groupData.users[userName] = { items: [] };
            currentUser = userName;
            isGroupCreator = true;

            // Apply theme based on selected event
            applyTheme(eventType);

            await saveData();
            localStorage.setItem(`creator_${groupId}`, userName);
            lastDataHash = hashData(groupData);
            showMainView();
            startPolling();
        });

        // Join form submission
        document.getElementById('joinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName = document.getElementById('joinUserName').value.trim();

            // CRITICAL FIX: Reload fresh data before modifying
            groupData = await loadGroupData(groupId);
            
            if (!groupData) {
                alert('Error loading group data. Please try again.');
                return;
            }

            if (!groupData.users[userName]) {
                groupData.users[userName] = { items: [] };
                await saveData();
            }

            currentUser = userName;
            localStorage.setItem(`user_${groupId}`, currentUser);
            lastDataHash = hashData(groupData);
            showMainView();
            startPolling();
        });

        async function saveData() {
            await saveGroupData(groupId, groupData);
            localStorage.setItem(`user_${groupId}`, currentUser);
            lastDataHash = hashData(groupData);
        }

        function copyLink() {
            const link = window.location.href;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard! üìã');
            }).catch(() => {
                alert('Could not copy link. Please copy it manually from the box above.');
            });
        }

        function shareLink() {
            const link = window.location.href;
            const text = `Join our ${groupData.eventType} gift exchange group: ${groupData.groupName}!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Gift Exchange',
                    text: text,
                    url: link
                }).catch(() => {
                    // If sharing fails, copy to clipboard
                    copyLink();
                });
            } else {
                // Fallback to copy
                copyLink();
            }
        }

        function renderMainView() {
            // Group info
            const eventDate = new Date(groupData.eventDate);
            const daysUntil = Math.ceil((eventDate - new Date()) / (1000 * 60 * 60 * 24));
            const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            document.getElementById('groupInfo').innerHTML = `
                <strong>${groupData.groupName}</strong> ¬∑ ${groupData.eventType}<br>
                ${dateStr} ${daysUntil > 0 ? `(${daysUntil} days!)` : daysUntil === 0 ? '(Today!)' : '(Past)'}<br>
                Signed in as: <strong>${currentUser}</strong>
            `;

            // Share link
            document.getElementById('shareLink').textContent = window.location.href;

            // My wishlist
            renderMyWishlist();

            // Others' wishlists
            renderOthersWishlists();

            // Update reset section visibility
            const resetSection = document.getElementById('resetSection');
            if (resetSection) {
                if (isGroupCreator) {
                    resetSection.style.display = 'block';
                } else {
                    resetSection.style.display = 'none';
                }
            }
        }

        function renderMyWishlist() {
            const myItems = groupData.users[currentUser].items;
            const myWishlistDiv = document.getElementById('myWishlist');
            const countBadge = document.getElementById('myWishlistCount');

            countBadge.textContent = `${myItems.length} item${myItems.length !== 1 ? 's' : ''}`;

            if (myItems.length === 0) {
                myWishlistDiv.innerHTML = '<div class="empty-state">Add items to your wishlist above! üéÅ</div>';
                return;
            }

            myWishlistDiv.innerHTML = myItems.map((item, index) => `
                <div class="item">
                    <div class="item-content">
                        <div class="item-header">
                            <div class="item-text">${item.description}</div>
                        </div>
                        <div class="item-meta">
                            ${item.priority === 'high' ? '<span class="meta-badge priority-high">‚≠ê High Priority</span>' : ''}
                            ${item.priority === 'medium' ? '<span class="meta-badge priority-medium">Medium Priority</span>' : ''}
                            ${item.priority === 'low' ? '<span class="meta-badge priority-low">Low Priority</span>' : ''}
                            ${item.price ? `<span class="meta-badge price-badge">üí∞ ${item.price}</span>` : ''}
                        </div>
                        ${item.details ? `<div class="item-details">${linkify(item.details)}</div>` : ''}
                        <button class="edit-details-btn secondary-btn" onclick="showEditDetailsModal(${index})">
                            ‚úèÔ∏è Edit Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderOthersWishlists() {
            const othersDiv = document.getElementById('othersWishlists');
            const others = Object.keys(groupData.users).filter(name => name !== currentUser);

            if (others.length === 0) {
                othersDiv.innerHTML = `
                    <div class="card">
                        <div class="empty-state">No one else has joined yet. Share the link above with your group! üéÑ</div>
                    </div>
                `;
                return;
            }

            othersDiv.innerHTML = others.map(personName => {
                const items = groupData.users[personName].items;
                return `
                    <div class="card wishlist-section">
                        <div class="wishlist-header">
                            <h2>${personName}'s Wishlist</h2>
                            <span class="badge">${items.length} item${items.length !== 1 ? 's' : ''}</span>
                        </div>
                        ${items.length === 0 ? 
                            '<div class="empty-state">No items yet</div>' :
                            items.map((item, index) => {
                                const isClaimed = item.claimedBy && item.claimedBy.length > 0;
                                const isClaimedByMe = isClaimed && item.claimedBy.includes(currentUser);
                                const claimers = isClaimed ? item.claimedBy : [];
                                const isPurchased = item.purchased || false;
                                
                                return `
                                <div class="item ${isClaimed ? 'claimed' : ''} ${isPurchased ? 'purchased' : ''}" 
                                     onclick="${isClaimed && !isClaimedByMe ? `showSplitModal('${personName}', ${index})` : ''}">
                                    <div class="item-content">
                                        <div class="item-header">
                                            <div class="item-text">${item.description}</div>
                                        </div>
                                        <div class="item-meta">
                                            ${item.priority === 'high' ? '<span class="meta-badge priority-high">‚≠ê High Priority</span>' : ''}
                                            ${item.priority === 'medium' ? '<span class="meta-badge priority-medium">Medium Priority</span>' : ''}
                                            ${item.priority === 'low' ? '<span class="meta-badge priority-low">Low Priority</span>' : ''}
                                            ${item.price ? `<span class="meta-badge price-badge">üí∞ ${item.price}</span>` : ''}
                                        </div>
                                        ${item.details ? `<div class="item-details">${linkify(item.details)}</div>` : ''}
                                        ${item.notes ? `<div class="item-notes">üìù ${item.notes}</div>` : ''}
                                        ${isClaimed ? `
                                            <div style="margin-top: 8px;">
                                                ${claimers.map(claimer => 
                                                    `<span class="claimed-by">‚úì ${claimer}</span>`
                                                ).join(' ')}
                                                ${claimers.length > 1 ? '<span class="split-badge">Split Gift</span>' : ''}
                                                ${isPurchased ? '<span class="purchased-badge">‚úì Purchased</span>' : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="item-actions" onclick="event.stopPropagation()">
                                        ${!isClaimed ? `
                                            <button onclick="claimItem('${personName}', ${index})">I'll Get This! üéÅ</button>
                                            <button class="secondary-btn" onclick="addNotesToItem('${personName}', ${index})">Add Notes üìù</button>
                                        ` : isClaimedByMe ? `
                                            <button class="secondary-btn" onclick="unclaimItem('${personName}', ${index})">Unclaim ‚Ü©Ô∏è</button>
                                            ${!isPurchased ? `<button onclick="markPurchased('${personName}', ${index})">Mark as Purchased ‚úì</button>` : ''}
                                        ` : ''}
                                    </div>
                                </div>
                            `}).join('')
                        }
                    </div>
                `;
            }).join('');
        }

        async function addItem() {
            const input = document.getElementById('newItemInput');
            const description = input.value.trim();
            const priority = document.getElementById('newItemPriority').value;
            const price = document.getElementById('newItemPrice').value;

            if (!description) return;

            // Reload fresh data before adding
            groupData = await loadGroupData(groupId);
            
            if (!groupData || !groupData.users[currentUser]) {
                alert('Error loading group data. Please refresh the page.');
                return;
            }

            groupData.users[currentUser].items.push({
                description: description,
                priority: priority,
                price: price,
                notes: '',
                details: '',
                claimedBy: [],
                purchased: false
            });

            await saveData();
            input.value = '';
            document.getElementById('newItemPriority').value = 'medium';
            document.getElementById('newItemPrice').value = '';
            
            renderMainView();
        }

        // Allow Enter key to add items
        document.getElementById('newItemInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addItem();
            }
        });

        async function claimItem(personName, itemIndex) {
            // Reload fresh data before claiming
            groupData = await loadGroupData(groupId);
            
            if (!groupData.users[personName].items[itemIndex].claimedBy) {
                groupData.users[personName].items[itemIndex].claimedBy = [];
            }
            groupData.users[personName].items[itemIndex].claimedBy.push(currentUser);
            await saveData();
            renderMainView();
        }

        async function unclaimItem(personName, itemIndex) {
            // Reload fresh data before unclaiming
            groupData = await loadGroupData(groupId);
            
            const claimers = groupData.users[personName].items[itemIndex].claimedBy;
            const index = claimers.indexOf(currentUser);
            if (index > -1) {
                claimers.splice(index, 1);
            }
            if (claimers.length === 0) {
                groupData.users[personName].items[itemIndex].purchased = false;
            }
            await saveData();
            renderMainView();
        }

        async function markPurchased(personName, itemIndex) {
            // Reload fresh data before marking purchased
            groupData = await loadGroupData(groupId);
            
            groupData.users[personName].items[itemIndex].purchased = true;
            await saveData();
            renderMainView();
        }

        async function addNotesToItem(personName, itemIndex) {
            const notes = prompt('Add notes (size, color, link, etc.):');
            if (notes && notes.trim()) {
                // Reload fresh data before adding notes
                groupData = await loadGroupData(groupId);
                
                groupData.users[personName].items[itemIndex].notes = notes.trim();
                await saveData();
                renderMainView();
            }
        }

        function showSplitModal(personName, itemIndex) {
            const item = groupData.users[personName].items[itemIndex];
            const claimers = item.claimedBy.join(', ');
            
            splitModalData = { personName, itemIndex };
            
            document.getElementById('splitModalBody').innerHTML = `
                <p>This gift is currently being purchased by <strong>${claimers}</strong>.</p>
                <p style="margin-top: 15px;">Would you like to split this gift with them?</p>
            `;
            
            document.getElementById('splitModal').style.display = 'block';
        }

        function closeSplitModal() {
            document.getElementById('splitModal').style.display = 'none';
            splitModalData = null;
        }

        async function confirmSplit() {
            if (splitModalData) {
                const { personName, itemIndex } = splitModalData;
                
                // Reload fresh data before splitting
                groupData = await loadGroupData(groupId);
                const item = groupData.users[personName].items[itemIndex];
                
                if (!item.claimedBy.includes(currentUser)) {
                    item.claimedBy.push(currentUser);
                    await saveData();
                    renderMainView();
                }
            }
            closeSplitModal();
        }

        // Edit Details Modal Functions
        function showEditDetailsModal(itemIndex) {
            const item = groupData.users[currentUser].items[itemIndex];
            editDetailsData = { itemIndex };
            
            document.getElementById('editDetailsTextarea').value = item.details || '';
            document.getElementById('editDetailsModal').style.display = 'block';
        }

        function closeEditDetailsModal() {
            document.getElementById('editDetailsModal').style.display = 'none';
            editDetailsData = null;
        }

        async function saveEditDetails() {
            if (!editDetailsData) return;
            
            const details = document.getElementById('editDetailsTextarea').value.trim();
            
            // Reload fresh data before saving
            groupData = await loadGroupData(groupId);
            
            if (!groupData || !groupData.users[currentUser]) {
                alert('Error loading group data. Please refresh the page.');
                return;
            }
            
            groupData.users[currentUser].items[editDetailsData.itemIndex].details = details;
            
            await saveData();
            renderMainView();
            closeEditDetailsModal();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const splitModal = document.getElementById('splitModal');
            const editModal = document.getElementById('editDetailsModal');
            
            if (event.target === splitModal) {
                closeSplitModal();
            }
            if (event.target === editModal) {
                closeEditDetailsModal();
            }
        }

        async function resetData() {
            if (!isGroupCreator) {
                alert('Only the group creator can reset the data.');
                return;
            }
            
            if (confirm('Are you sure you want to reset everything? This will clear all data for everyone in the group and cannot be undone.')) {
                stopPolling();
                await deleteGroupData(groupId);
                localStorage.removeItem(`user_${groupId}`);
                localStorage.removeItem(`creator_${groupId}`);
                window.location.hash = '';
                location.reload();
            }
        }

        // Clean up polling when page is hidden/closed
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPolling();
            } else if (groupId && groupData) {
                startPolling();
            }
        });

        // Initialize on load
        init();
    </script>
</body>
</html>